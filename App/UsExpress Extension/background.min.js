const exprire_time_store=864e5,remove_check_time=36e5,get_fee_new_url="http://api.usexpressvn.com/api/ServicePublic/extension/get-fee.json",get_xpath_url="http://api.usexpressvn.com/api/ServicePublic/extension/get-xpath",key_token_api="kq1jnJAJShgdRPYjiMyi",xpath_key="od5XHJ1tIJQlSET9aTAulNO5ES1XTirfI2epe1QV";var xpath_list=void 0,excute_flag=0;chrome.runtime.onInstalled.addListener(e=>{_common.FetchAPI(function(e){}),setInterval(function(){_background_service.RemoveProductDetail()},remove_check_time),setInterval(function(){_common.FetchAPI(function(e){})},exprire_time_store)}),chrome.runtime.onMessage.addListener(function(e,t,a){switch(e.function_name){case"get_fee_new":try{var n="us_"+_common.GetAmzASINFromURL(e.url)+"_"+e.label_id;_background_service.GetProductDetailByKey(n,function(t){if(null!=t&&null!=t&&null!=t.data&&t.data!={}&&t.data.PRICE>0)t=JSON.parse(t),a({response:"Success",PRICE:null==t.data.product_price?0:t.data.product_price,FIRST_POUND_FEE:null==t.data.first_pound_fee?0:t.data.first_pound_fee,NEXT_POUND_FEE:null==t.data.next_pound_fee?0:t.data.next_pound_fee,LUXURY_FEE:null==t.data.luxury_fee?0:t.data.luxury_fee,DISCOUNT_FIRST_FEE:null==t.data.discount_first_fee?0:t.data.discount_first_fee,TOTAL_SHIPPING_FEE:null==t.data.total_shipping_fee?0:t.data.total_shipping_fee,PRICE_LAST:null==t.data.price_last?0:t.data.price_last,PRICE_LAST_VND:null==t.data.price_last_vnd?0:t.data.price_last_vnd,url_usexpress_detail:t.data.url});else{var o=get_fee_new_url,r={price:e.price,label_id:e.label_id,pound:e.item_weight,shipping_fee:e.shipping_fee,unit:e.unit,product_name:e.product_name,product_code:_common.GetAmzASINFromURL(e.url)};switch(e.label_id){case 7:r.product_name="jomashop",r.product_code=_common.GetOtherLabelASINFromURL(e.url,e.label_id)}var c=_common.KeyEncode(r,key_token_api),_=c;fetch(o,{method:"POST",headers:{Accept:"application/json, application/xml, text/plain, text/html, *.*","Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},body:"token="+_}).then(function(e){200!==e.status&&a({response:"Failed"}),e.json().then(function(e){var t={data:e.data,created_time:Date.now()};_background_service.SetProductDetail(n,t);var o={response:"Success",PRICE:null==t.data.product_price?0:t.data.product_price,FIRST_POUND_FEE:null==t.data.first_pound_fee?0:t.data.first_pound_fee,NEXT_POUND_FEE:null==t.data.next_pound_fee?0:t.data.next_pound_fee,LUXURY_FEE:null==t.data.luxury_fee?0:t.data.luxury_fee,DISCOUNT_FIRST_FEE:null==t.data.discount_first_fee?0:t.data.discount_first_fee,TOTAL_SHIPPING_FEE:null==t.data.total_shipping_fee?0:t.data.total_shipping_fee,PRICE_LAST:null==t.data.price_last?0:t.data.price_last,PRICE_LAST_VND:null==t.data.price_last_vnd?0:t.data.price_last_vnd,url_usexpress_detail:t.data.url};a(o)})}).catch(function(e){a({response:"Failed"})})}})}catch(e){a({response:"Failed"})}break;case"get_product_code":switch(e.label_id){case 1:var o=_common.GetAmzASINFromURL(e.url);a({response:"Success",product_code:o});break;case 7:o=_common.GetOtherLabelASINFromURL(e.url,e.label_id);a({response:"Success",product_code:o})}break;case"get_xpath":try{0==excute_flag?_common.FetchAPI(function(t){a(null==t?{response:"Failed"}:{response:"Success",data:t[e.label_name.toLowerCase()]})}):a({response:"Success",data:xpath_list[e.label_name.toLowerCase()]})}catch(e){a({response:"Failed"})}}return!0});var _background_service={GetProductDetailByKey:function(e,t){chrome.storage.local.get(""+e,function(a){t(a[e])})},SetProductDetail:function(e,t){var a=JSON.stringify(t);null!=t.data&&chrome.storage.local.set({[""+e]:a},function(){})},RemoveProductDetail:function(){chrome.storage.local.get(null,function(e){for(key in e){var t=JSON.parse(e[key]);t.created_time+exprire_time_store<Date.now()&&chrome.storage.local.remove([""+key],function(){var e=chrome.runtime.lastError;e&&console.error(e)})}})}},_common={base64abc:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],KeyED:function(e,t){var a=e.length,n=t.length,o=[];for(i=0;i<a;i++){var r=i%n,c=e.charCodeAt(i),_=t.charCodeAt(r),l=c^_;o[i]=String.fromCharCode(l)}var s=o.join("");return s},KeyEncode:function(e,t){var a=_common.KeyED(JSON.stringify(e),t),n=_common.stringToUtf8ByteArray(a);return e=_common.bytesToBase64(n),e},bytesToBase64:function(e){let t,a="",n=e.length;for(t=2;t<n;t+=3)a+=_common.base64abc[e[t-2]>>2],a+=_common.base64abc[(3&e[t-2])<<4|e[t-1]>>4],a+=_common.base64abc[(15&e[t-1])<<2|e[t]>>6],a+=_common.base64abc[63&e[t]];return t===n+1&&(a+=_common.base64abc[e[t-2]>>2],a+=_common.base64abc[(3&e[t-2])<<4],a+="=="),t===n&&(a+=_common.base64abc[e[t-2]>>2],a+=_common.base64abc[(3&e[t-2])<<4|e[t-1]>>4],a+=_common.base64abc[(15&e[t-1])<<2],a+="="),a},stringToUtf8ByteArray:function(e){for(var t=[],a=0,n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t[a++]=o:o<2048?(t[a++]=o>>6|192,t[a++]=63&o|128):55296==(64512&o)&&n+1<e.length&&56320==(64512&e.charCodeAt(n+1))?(o=65536+((1023&o)<<10)+(1023&e.charCodeAt(++n)),t[a++]=o>>18|240,t[a++]=o>>12&63|128,t[a++]=o>>6&63|128,t[a++]=63&o|128):(t[a++]=o>>12|224,t[a++]=o>>6&63|128,t[a++]=63&o|128)}return t},GetAmzASINFromURL:function(e){try{-1==e.split("/")[0].indexOf("http")&&(e="https://www.amazon.com"+e),e=e.replace(/\n/g,"");var t,a="https://www.amazon.com/([\\w-]+/)?(dp|gp/product|gp/aw/d)/(\\w+/)?(\\w{10})",n="(?:[/dp/]|$)([A-Z0-9]{10})",o=e.match(a);null!=o?t=o[0]:(o=e.match(n),t=o[0]);var r=t.split("/"),c=r[r.length-1];return c.indexOf("B0")>=1&&(r=c.split("B0"),c="B0"+r[r.length-1]),c}catch(e){return null}},GetOtherLabelASINFromURL:function(e,t){switch(t){case 1:return _common.GetAmzASINFromURL(e);case 7:var a=e.split("/");return a[a.length-1]}},FetchAPI:function(e){var t=get_xpath_url;fetch(t,{method:"POST",headers:{Accept:"application/json, application/xml, text/plain, text/html, *.*","Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},body:"key="+xpath_key}).then(function(t){t.json().then(function(t){xpath_list={},0==t.status&&(xpath_list=t.data,excute_flag=1),e(xpath_list)})}).catch(function(t){e(void 0)})}};